<!DOCTYPE html>
<html lang="en" class="dark">

<!-- Updated: 2025-11-21 -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simon Allmer Portfolio</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        background: '#020617', // Slate 950 (Darker)
                        surface: '#0f172a', // Slate 900
                        'surface-highlight': '#1e293b', // Slate 800
                        primary: '#3b82f6',

                        // Status Colors
                        'status-red': '#ef4444',
                        'status-yellow': '#facc15',
                        'status-green': '#22c55e',

                        // Brand Colors
                        'sa-blue': '#bfdbfe',
                        'sa-darkblue': '#60a5fa',
                    },
                    boxShadow: {
                        'glow-red': '0 0 10px rgba(239, 68, 68, 0.3), inset 0 0 5px rgba(239, 68, 68, 0.1)',
                        'glow-yellow': '0 0 10px rgba(250, 204, 21, 0.3), inset 0 0 5px rgba(250, 204, 21, 0.1)',
                        'glow-green': '0 0 10px rgba(34, 197, 94, 0.3), inset 0 0 5px rgba(34, 197, 94, 0.1)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #020617;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        body {
            background-color: #020617;
            color: #f8fafc;
            overflow-x: hidden;
        }

        /* Glass/Card Styles */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .dashboard-card {
            background-color: #0f172a;
            /* Surface */
            border: 1px solid #1e293b;
            /* Highlight border */
            border-radius: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            border-color: #334155;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* Navigation Tabs */
        .nav-tab {
            position: relative;
            transition: all 0.3s ease;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 2px;
            background: #60a5fa;
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-tab:hover::after {
            width: 80%;
        }

        .nav-tab.active {
            color: #bfdbfe;
        }

        .nav-tab.active::after {
            width: 100%;
        }

        /* Country Buttons */
        .country-btn {
            background-color: #1e293b;
            /* Surface Highlight */
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .country-btn:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        /* Status Borders & Glows */
        .border-status-red {
            border-color: #ef4444;
        }

        .border-status-yellow {
            border-color: #facc15;
        }

        .border-status-green {
            border-color: #22c55e;
        }

        .country-btn.status-red:hover {
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }

        .country-btn.status-yellow:hover {
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.4);
        }

        .country-btn.status-green:hover {
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease-out forwards;
        }

        .delay-100 {
            animation-delay: 100ms;
        }

        .delay-200 {
            animation-delay: 200ms;
        }

        .delay-300 {
            animation-delay: 300ms;
        }

        /* Modal */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        /* Dropdown */
        .dropdown-group:hover .dropdown-menu {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Password Protection Overlay -->
    <div id="password-overlay"
        class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950">
        <div class="text-center px-6">
            <div class="mb-12 pt-20">
                <h1 class="text-4xl md:text-5xl font-bold text-white tracking-[0.2em] uppercase"
                    style="font-family: 'Futura', 'Inter', sans-serif;">Catalog</h1>
            </div>
            <div class="bg-surface border border-slate-700 rounded-2xl p-8 shadow-2xl max-w-md mx-auto">
                <div class="mb-6">
                    <svg class="w-16 h-16 mx-auto text-sa-blue mb-4" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                        </path>
                    </svg>
                    <h2 class="text-2xl font-bold text-white mb-2">Access Required</h2>
                    <p class="text-slate-400 text-sm">This is a private document</p>
                </div>
                <form onsubmit="checkPassword(event)" class="space-y-4">
                    <div>
                        <input type="password" id="password-input" placeholder="Enter password"
                            class="w-full px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-sa-blue focus:outline-none focus:ring-2 focus:ring-sa-blue/50 transition-all"
                            autocomplete="off" />
                    </div>
                    <button type="submit"
                        class="w-full bg-sa-blue hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-xl">
                        Unlock Portfolio
                    </button>
                    <p id="password-error" class="text-red-400 text-sm hidden">Incorrect password. Please try again.</p>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Content (Hidden until password is correct) -->
    <div id="main-app" class="hidden flex-1 flex flex-col">

        <!-- Header with extra top padding for Squarespace -->
        <header class="pt-32 pb-12 text-center animate-fade-in">
            <h1 class="text-4xl md:text-5xl font-bold text-white tracking-[0.2em] uppercase cursor-pointer"
                style="font-family: 'Futura', 'Inter', sans-serif;" onclick="switchTab('home')">Catalog</h1>
        </header>

        <!-- Navigation -->
        <nav class="mb-8 overflow-x-auto md:overflow-visible">
            <div class="flex justify-center min-w-max space-x-2 md:space-x-8 px-4 border-b border-slate-800">
                <button class="nav-tab active py-4 px-2 text-slate-300 font-medium hover:text-white"
                    onclick="switchTab('home')">Home</button>
                <button class="nav-tab py-4 px-2 text-slate-300 font-medium hover:text-white"
                    onclick="switchTab('projects')">Projects</button>
                <button class="nav-tab py-4 px-2 text-slate-300 font-medium hover:text-white"
                    onclick="switchTab('studios')">Studios</button>
                <button class="nav-tab py-4 px-2 text-slate-300 font-medium hover:text-white"
                    onclick="switchTab('products')">Products</button>
                <button class="nav-tab py-4 px-2 text-slate-300 font-medium hover:text-white"
                    onclick="switchTab('brands')">Brands</button>
                <button class="nav-tab py-4 px-2 text-slate-300 font-medium hover:text-white"
                    onclick="switchTab('events')">Events</button>
                <button class="nav-tab py-4 px-2 text-slate-300 font-medium hover:text-white"
                    onclick="switchTab('assets')">Assets</button>

                <!-- Knowledge Dropdown -->
                <button class="nav-tab py-4 px-2 text-slate-300 font-medium hover:text-white"
                    onclick="switchTab('dictionary')">Dictionary</button>
            </div>
        </nav>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow max-w-7xl mx-auto w-full px-4 pb-12 transition-opacity duration-300">
            <!-- Content injected via JS -->
        </main>

        <!-- Sub Page Container (Hidden by default) -->
        <div id="sub-page-container" class="hidden flex-grow max-w-7xl mx-auto w-full px-4 pb-12 animate-fade-in">
            <!-- Sub page content injected via JS -->
        </div>

        <!-- Detail Modal -->
        <div id="detail-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog"
            aria-modal="true">
            <div class="fixed inset-0 modal-backdrop transition-opacity opacity-0" id="modal-backdrop"></div>
            <div class="fixed inset-0 z-10 overflow-y-auto">
                <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                    <div class="relative transform overflow-hidden rounded-2xl bg-surface border border-slate-700 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg opacity-0 scale-95"
                        id="modal-panel">
                        <div class="bg-surface px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-2xl font-display font-bold text-white" id="modal-title">Title</h3>
                                <button type="button" class="text-slate-400 hover:text-white transition-colors"
                                    onclick="closeModal()">
                                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div class="mt-2" id="modal-body">
                                <!-- Modal Content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inline Script to avoid CORS/Module issues locally -->
        <script type="module">
            // Password Protection
            const CORRECT_PASSWORD = '2020';

            window.checkPassword = function (event) {
                event.preventDefault();
                const input = document.getElementById('password-input');
                const error = document.getElementById('password-error');

                if (input.value === CORRECT_PASSWORD) {
                    document.getElementById('password-overlay').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    sessionStorage.setItem('portfolio_authenticated', 'true');
                    // Initialize the home page
                    setTimeout(() => {
                        if (window.switchTab) {
                            window.switchTab('home');
                        } else {
                            // Fallback if switchTab isn't ready yet or not global
                            document.dispatchEvent(new Event('init-app'));
                        }
                    }, 100);
                } else {
                    error.classList.remove('hidden');
                    input.value = '';
                    input.focus();
                    setTimeout(() => error.classList.add('hidden'), 3000);
                }
            };

            // Check if already authenticated in this session
            if (sessionStorage.getItem('portfolio_authenticated') === 'true') {
                document.getElementById('password-overlay').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                // Initialize the home page
                setTimeout(() => switchTab('home'), 100);
            }

            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
            import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

            // --- DATA ---
            const countryData = {
                'Canada': {
                    region: 'America', flag: 'ðŸ‡¨ðŸ‡¦', population: '38.2 Million',
                    largestCities: [{ name: 'Toronto', pop: '6.2M' }, { name: 'Montreal', pop: '4.2M' }, { name: 'Vancouver', pop: '2.6M' }],
                    cities: ['Toronto', 'Vancouver'], entities: ['Allmer CA'], realEstate: 0, partners: [], note: 'North American content localization.', presenceLevel: 'red'
                },
                'United States': {
                    region: 'America', flag: 'ðŸ‡ºðŸ‡¸', population: '331.9 Million',
                    largestCities: [{ name: 'New York', pop: '8.8M' }, { name: 'Los Angeles', pop: '3.9M' }, { name: 'Chicago', pop: '2.7M' }],
                    cities: ['New York', 'Los Angeles'], entities: ['Allmer Ent. LLC'], realEstate: 0, partners: [], note: 'Largest single market.', presenceLevel: 'red'
                },
                'Mexico': {
                    region: 'America', flag: 'ðŸ‡²ðŸ‡½', population: '126.7 Million',
                    largestCities: [{ name: 'Mexico City', pop: '9.2M' }, { name: 'Tijuana', pop: '1.8M' }, { name: 'Ecatepec', pop: '1.6M' }],
                    cities: ['Mexico City'], entities: ['Allmer MX'], realEstate: 0, partners: [], note: 'LatAm hub.', presenceLevel: 'red'
                },
                'Colombia': {
                    region: 'America', flag: 'ðŸ‡¨ðŸ‡´', population: '51.5 Million',
                    largestCities: [{ name: 'BogotÃ¡', pop: '7.7M' }, { name: 'MedellÃ­n', pop: '2.5M' }, { name: 'Cali', pop: '2.2M' }],
                    cities: ['BogotÃ¡'], entities: ['Allmer CO'], realEstate: 0, partners: [], note: 'Andean region base.', presenceLevel: 'red'
                },
                'Peru': {
                    region: 'America', flag: 'ðŸ‡µðŸ‡ª', population: '33.7 Million',
                    largestCities: [{ name: 'Lima', pop: '9.7M' }, { name: 'Arequipa', pop: '1.0M' }, { name: 'Trujillo', pop: '0.9M' }],
                    cities: ['Lima'], entities: ['Allmer PE'], realEstate: 0, partners: [], note: 'Andean market.', presenceLevel: 'red'
                },
                'Brazil': {
                    region: 'America', flag: 'ðŸ‡§ðŸ‡·', population: '214.3 Million',
                    largestCities: [{ name: 'SÃ£o Paulo', pop: '12.3M' }, { name: 'Rio de Janeiro', pop: '6.7M' }, { name: 'BrasÃ­lia', pop: '3.0M' }],
                    cities: ['SÃ£o Paulo'], entities: ['Allmer BR'], realEstate: 0, partners: [], note: 'Key e-commerce market.', presenceLevel: 'red'
                },
                'Argentina': {
                    region: 'America', flag: 'ðŸ‡¦ðŸ‡·', population: '45.8 Million',
                    largestCities: [{ name: 'Buenos Aires', pop: '2.9M' }, { name: 'CÃ³rdoba', pop: '1.3M' }, { name: 'Rosario', pop: '0.9M' }],
                    cities: ['Buenos Aires'], entities: ['Allmer AR'], realEstate: 0, partners: [], note: 'Southern Cone base.', presenceLevel: 'red'
                },

                'United Kingdom': {
                    region: 'Europe', flag: 'ðŸ‡¬ðŸ‡§', population: '67.3 Million',
                    largestCities: [{ name: 'London', pop: '8.9M' }, { name: 'Birmingham', pop: '1.1M' }, { name: 'Glasgow', pop: '0.6M' }],
                    cities: ['London'], entities: ['Allmer UK Ltd'], realEstate: 0, partners: [], note: 'Primary English market in Europe.', presenceLevel: 'red'
                },
                'Portugal': {
                    region: 'Europe', flag: 'ðŸ‡µðŸ‡¹', population: '10.3 Million',
                    largestCities: [{ name: 'Lisbon', pop: '0.5M' }, { name: 'Porto', pop: '0.2M' }, { name: 'Vila Nova de Gaia', pop: '0.3M' }],
                    cities: ['Lisbon'], entities: ['Allmer PT'], realEstate: 0, partners: [], note: 'Gateway to Brazil.', presenceLevel: 'red'
                },
                'Spain': {
                    region: 'Europe', flag: 'ðŸ‡ªðŸ‡¸', population: '47.4 Million',
                    largestCities: [{ name: 'Madrid', pop: '3.2M' }, { name: 'Barcelona', pop: '1.6M' }, { name: 'Valencia', pop: '0.8M' }],
                    cities: ['Madrid', 'Barcelona'], entities: ['Allmer ES'], realEstate: 0, partners: [], note: 'Spanish market hub.', presenceLevel: 'red'
                },
                'France': {
                    region: 'Europe', flag: 'ðŸ‡«ðŸ‡·', population: '67.7 Million',
                    largestCities: [{ name: 'Paris', pop: '2.1M' }, { name: 'Marseille', pop: '0.8M' }, { name: 'Lyon', pop: '0.5M' }],
                    cities: ['Paris'], entities: ['Allmer FR'], realEstate: 0, partners: [], note: 'Music distribution.', presenceLevel: 'red'
                },
                'Germany': {
                    region: 'Europe', flag: 'ðŸ‡©ðŸ‡ª', population: '83.2 Million',
                    largestCities: [{ name: 'Berlin', pop: '3.6M' }, { name: 'Hamburg', pop: '1.8M' }, { name: 'Munich', pop: '1.4M' }],
                    cities: ['Hamburg', 'Frankfurt'], entities: ['Allmer DE'], realEstate: 0, partners: [], note: 'Gaming market.', presenceLevel: 'red'
                },
                'Italy': {
                    region: 'Europe', flag: 'ðŸ‡®ðŸ‡¹', population: '59.1 Million',
                    largestCities: [{ name: 'Rome', pop: '4.3M' }, { name: 'Milan', pop: '3.1M' }, { name: 'Naples', pop: '2.2M' }],
                    cities: ['Rome', 'Milan'], entities: ['Allmer IT Srl'], realEstate: 0, partners: ['Film Production Studio A', 'Merchandise Distributor B'], note: 'Film partnerships.', presenceLevel: 'yellow'
                },
                'Austria': {
                    region: 'Europe', flag: 'ðŸ‡¦ðŸ‡¹', population: '8.9 Million',
                    largestCities: [{ name: 'Vienna', pop: '1.9M' }, { name: 'Salzburg', pop: '0.15M' }],
                    cities: ['Vienna', 'Salzburg'], entities: ['Allmer AT GmbH'], contacts: [{ name: 'Nikolaus Peschl', city: 'Vienna' }], realEstate: 3, realEstateDetails: [{ name: 'Wieden', type: 'Mixed', city: 'Vienna' }, { name: 'DÃ¶bling', type: 'Residential', city: 'Vienna' }, { name: 'Wagram', type: 'Invest', city: 'Vienna' }], partners: [{ name: 'Paradice', url: 'https://www.paradice.wien', cities: ['Vienna'] }, { name: 'Zuckerlwerkstatt', url: 'https://www.zuckerlwerkstatt.at', cities: ['Vienna', 'Salzburg'] }], note: 'Global HQ.', presenceLevel: 'green'
                },

                'India': {
                    region: 'Asia', flag: 'ðŸ‡®ðŸ‡³', population: '1.38 Billion',
                    largestCities: [{ name: 'Mumbai', pop: '12.5M' }, { name: 'Delhi', pop: '11.0M' }, { name: 'Bangalore', pop: '8.4M' }],
                    cities: ['Mumbai'], entities: ['Allmer IN'], realEstate: 0, partners: [{ name: 'Mayank Kumarr', url: 'https://www.artstation.com/mayankkumar77' }], note: 'Mobile games growth.', presenceLevel: 'yellow'
                },
                'Singapore': {
                    region: 'Asia', flag: 'ðŸ‡¸ðŸ‡¬', population: '5.7 Million',
                    largestCities: [{ name: 'Singapore', pop: '5.7M' }],
                    cities: ['Singapore'], entities: ['Allmer SG'], realEstate: 0, partners: [], note: 'Financial Hub.', presenceLevel: 'red'
                },
                'Indonesia': {
                    region: 'Asia', flag: 'ðŸ‡®ðŸ‡©', population: '273.5 Million',
                    largestCities: [{ name: 'Jakarta', pop: '10.5M' }, { name: 'Surabaya', pop: '2.8M' }, { name: 'Bandung', pop: '2.4M' }],
                    cities: ['Jakarta'], entities: ['Allmer ID'], realEstate: 0, partners: [], note: 'SE Asia growth.', presenceLevel: 'red'
                },
                'China': {
                    region: 'Asia', flag: 'ðŸ‡¨ðŸ‡³', population: '1.41 Billion',
                    largestCities: [{ name: 'Shanghai', pop: '29.2M' }, { name: 'Beijing', pop: '21.9M' }, { name: 'Chongqing', pop: '32.1M' }],
                    cities: ['Beijing', 'Shanghai'], entities: ['Allmer CN'], realEstate: 0, partners: [{ name: 'Jang Jae Ok', url: 'https://jangjaeok.artstation.com' }, { name: 'DoFine Games', url: 'https://www.dofinegames.com' }], note: 'Complex partnerships.', presenceLevel: 'yellow'
                },
                'South Korea': {
                    region: 'Asia', flag: 'ðŸ‡°ðŸ‡·', population: '51.7 Million',
                    largestCities: [{ name: 'Seoul', pop: '9.7M' }, { name: 'Busan', pop: '3.4M' }, { name: 'Incheon', pop: '2.9M' }],
                    cities: ['Seoul'], entities: ['Allmer KR'], realEstate: 0, partners: [{ name: 'Yong Hoo Kim', url: 'https://www.instagram.com/hopkins__kim/' }], note: 'E-Sports focus.', presenceLevel: 'yellow'
                },
                'Japan': {
                    region: 'Asia', flag: 'ðŸ‡¯ðŸ‡µ', population: '125.8 Million',
                    largestCities: [{ name: 'Tokyo', pop: '13.9M' }, { name: 'Yokohama', pop: '3.7M' }, { name: 'Osaka', pop: '2.7M' }],
                    cities: ['Tokyo'], entities: ['Allmer JP'], realEstate: 0, partners: [{ name: 'Hanayama', url: 'https://hanayama-toys.com' }], note: 'IP market.', presenceLevel: 'red'
                },
                'Australia': {
                    region: 'Asia', flag: 'ðŸ‡¦ðŸ‡º', population: '25.7 Million',
                    largestCities: [{ name: 'Sydney', pop: '5.3M' }, { name: 'Melbourne', pop: '5.0M' }, { name: 'Brisbane', pop: '2.5M' }],
                    cities: ['Sydney'], entities: ['Allmer AU'], realEstate: 0, partners: [], note: 'Oceania logistics.', presenceLevel: 'red'
                },



            };

            const subdivisions = {
                'Allmer Studios': ['Allmer Comics', 'Allmer Films', 'Allmer Music', 'Allmer Games', 'Allmer Journals', 'Allmer Snacks'],
                'Allmer Brands': ['Franchise Development', 'Extensions', 'Merchandise', 'Communications'],
                'Simon Allmer Stores': ['Website', 'Apple', 'Google', 'Microsoft'],
                'Simon Allmer Centers': ['America', 'Europe', 'Africa', 'Asia']
            };

            const communicationsData = [
                {
                    handle: '@simonallmer',
                    name: 'Simon Allmer',
                    website: 'simonallmer.com',
                    platforms: { 'YouTube': true, 'Instagram': true, 'Threads': true, 'X': true },
                    url: 'https://instagram.com/simonallmer'
                },
                {
                    handle: '@allmercomics',
                    name: 'Allmer Comics',
                    website: 'allmercomics.com',
                    platforms: { 'YouTube': true, 'Instagram': true, 'Threads': true, 'X': true },
                    url: 'https://instagram.com/allmercomics'
                },
                {
                    handle: '@allmerfilms',
                    name: 'Allmer Films',
                    website: 'allmerfilms.com',
                    platforms: { 'YouTube': true, 'Instagram': true, 'Threads': true, 'X': true },
                    url: 'https://instagram.com/allmerfilms'
                },
                {
                    handle: '@allmermusic',
                    name: 'Allmer Music',
                    website: 'allmermusic.com',
                    platforms: { 'YouTube': true, 'Instagram': true, 'Threads': true, 'X': true },
                    url: 'https://instagram.com/allmermusic'
                },
                {
                    handle: '@allmergames',
                    name: 'Allmer Games',
                    website: 'allmergames.com',
                    platforms: { 'YouTube': true, 'Instagram': true, 'Threads': true, 'X': true },
                    url: 'https://instagram.com/allmergames'
                },
                {
                    handle: '@allmerjournals',
                    name: 'Allmer Journals',
                    website: 'allmerjournals.com',
                    platforms: { 'YouTube': true, 'Instagram': true, 'Threads': true, 'X': true },
                    url: 'https://instagram.com/allmerjournals'
                },
                {
                    handle: '@allmersnacks',
                    name: 'Allmer Snacks',
                    website: 'allmersnacks.com',
                    platforms: { 'YouTube': true, 'Instagram': true, 'Threads': true, 'X': true },
                    url: 'https://instagram.com/allmersnacks'
                },
                {
                    handle: '@amerportrait',
                    name: 'American Portrait',
                    website: null,
                    platforms: { 'YouTube': false, 'Instagram': true, 'Threads': false, 'X': false },
                    url: 'https://instagram.com/amerportrait'
                },
                {
                    handle: '@detectivenoname',
                    name: 'Detective Noname',
                    website: null,
                    platforms: { 'YouTube': false, 'Instagram': true, 'Threads': false, 'X': false },
                    url: 'https://instagram.com/detectivenoname'
                },
                {
                    handle: '@futorysaga',
                    name: 'Futory',
                    website: 'futory.com',
                    platforms: { 'YouTube': false, 'Instagram': true, 'Threads': false, 'X': false },
                    url: 'https://instagram.com/futorysaga'
                },
                {
                    handle: '@lunyracity',
                    name: 'Lunyra',
                    website: 'lunyra.com',
                    platforms: { 'YouTube': false, 'Instagram': true, 'Threads': false, 'X': false },
                    url: 'https://instagram.com/lunyracity'
                },
                {
                    handle: '@sevenwondersgame',
                    name: 'Seven Wonders',
                    website: null,
                    platforms: { 'YouTube': false, 'Instagram': true, 'Threads': false, 'X': false },
                    url: 'https://instagram.com/sevenwondersgame'
                },
                {
                    handle: '@societyreview',
                    name: 'Society Review',
                    website: 'societyreview.org',
                    platforms: { 'YouTube': true, 'Instagram': true, 'Threads': false, 'X': false },
                    url: 'https://instagram.com/societyreview'
                }
            ];

            const projectData = [
                {
                    title: "Believe",
                    studio: "Allmer Games",
                    budget: "â‚¬8,800 (â‚¬4,800 Illus. + â‚¬4,000 Print)",
                    steps: [
                        { name: "Illustrations", detail: "By Mayank Kumarr", status: "active", progress: "5/80" },
                        { name: "Printing", detail: "DoFine Games (Shanghai)", status: "pending" },
                        { name: "Sales", detail: "Simon Allmer Store", status: "pending" }
                    ]
                },
                {
                    title: "American Portrait",
                    subtitle: "Kissinger: A World Destroyed",
                    studio: "Allmer Comics",
                    budget: "â‚¬10,000 (Estimated)",
                    steps: [
                        { name: "Screenplay", detail: "Writing Phase", status: "done" },
                        { name: "Illustrations", detail: "Artist TBD", status: "active" },
                        { name: "Printing", detail: "Printer TBD", status: "pending" },
                        { name: "Sales", detail: "Simon Allmer Store", status: "pending" }
                    ]
                },
                {
                    title: "Sin Album",
                    studio: "Allmer Music",
                    budget: "â‚¬0",
                    steps: [
                        { name: "Song Writing", detail: "Lyrics & Composition", status: "done" },
                        { name: "Song Recording", detail: "Studio Recording", status: "active" },
                        { name: "Videoshoot", detail: "Music Videos", status: "pending" },
                        { name: "Release", detail: "Allmer Music", status: "pending" }
                    ]
                }
            ];

            const partnersData = [
                {
                    name: "Simon Allmer",
                    role: "Singer, Dancer, Actor, Writer, Director, Producer",
                    projects: ["All Projects"],
                    birthday: "September 11, 1999"
                },
                {
                    name: "David Kissinger",
                    role: "Film Producer and Script Advisor",
                    projects: ["American Portrait"],
                    birthday: "July 31, 1961"
                },
                {
                    name: "Eric Schmidt",
                    role: "Film Producer",
                    projects: ["American Portrait"],
                    birthday: "April 27, 1955"
                }
            ];

            const studiosData = {
                'Allmer Comics': {
                    website: 'allmercomics.com',
                    products: ['Comic Books', 'Digital Comics'],
                    technicalInsight: 'Sequential art meets cinematic storytelling. Every panel is crafted with film-quality composition and narrative depth.',
                    partners: [],
                    color: '#ef4444',
                    assets: [
                        { name: 'Artstation', url: 'https://www.artstation.com' }
                    ],
                    externalDatabases: [
                        { name: 'Grand Comics Database', url: 'https://www.comics.org/' },
                        { name: 'Goodreads', url: 'https://www.goodreads.com/author/show/57946604.Simon_Allmer' }
                    ]
                },
                'Allmer Films': {
                    website: 'allmerfilms.com',
                    products: ['Feature Films', 'Limited Series'],
                    technicalInsight: 'Independent filmmaking with studio-quality production values. Story-first approach with global distribution reach.',
                    partners: [],
                    color: '#3b82f6',
                    assets: [],
                    externalDatabases: [
                        { name: 'IMDb', url: 'https://www.imdb.com/name/nm10559153/' }
                    ]
                },
                'Allmer Music': {
                    website: 'allmermusic.com',
                    products: ['Albums', 'Music Videos', 'Musical Instruments'],
                    technicalInsight: 'Genre-fluid artistry combining classical training with modern production techniques. Multi-platform distribution strategy.',
                    partners: [],
                    color: '#facc15',
                    assets: [
                        { name: 'Suno', url: 'https://suno.com' }
                    ],
                    externalDatabases: []
                },
                'Allmer Games': {
                    website: 'allmergames.com',
                    products: ['Tabletop Games', 'Video Games', 'Toys'],
                    technicalInsight: '',
                    partners: [{ name: 'Paradice (Tabletop Game Events)', url: 'https://www.paradice.wien' }],
                    color: '#22c55e',
                    assets: [
                        { name: 'GitHub', url: 'https://github.com/allmergames' },
                        { name: 'Fusion 360', url: 'https://simonallmer.autodesk360.com' }
                    ],
                    externalDatabases: [
                        { name: 'IMDb', url: 'https://www.imdb.com/name/nm10559153/' },
                        { name: 'BoardGameGeek', url: 'https://boardgamegeek.com/boardgamepublisher/49179/allmer-games' },
                        { name: 'VideoGameGeek', url: 'https://videogamegeek.com/wiki/page/company:49179' }
                    ]
                },
                'Allmer Journals': {
                    website: 'allmerjournals.com',
                    products: ['Journals', 'Books'],
                    technicalInsight: 'Thought leadership meets accessible journalism. Bridging academia and popular discourse with rigorous editorial standards.',
                    partners: [],
                    color: '#92400e',
                    assets: [],
                    externalDatabases: [
                        { name: 'Goodreads', url: 'https://www.goodreads.com/author/show/57946604.Simon_Allmer' }
                    ]
                },
                'Allmer Snacks': {
                    website: 'allmersnacks.com',
                    products: ['Foods', 'Beverages'],
                    technicalInsight: '',
                    partners: ['Zuckerlwerkstatt (Snack Production)'],
                    color: '#ec4899',
                    assets: [],
                    externalDatabases: [
                        { name: 'Taquitos.net', url: 'https://www.taquitos.net' }
                    ]
                }
            };

            const dictionaryData = [
                { name: 'Allmer Comics', type: 'Studio', description: 'Coming soon to follow' },
                { name: 'Allmer Films', type: 'Studio', description: 'Coming soon to follow' },
                { name: 'Allmer Music', type: 'Studio', description: 'Coming soon to follow' },
                { name: 'Allmer Games', type: 'Studio', description: 'Coming soon to follow' },
                { name: 'Allmer Journals', type: 'Studio', description: 'Coming soon to follow' },
                { name: 'Allmer Snacks', type: 'Studio', description: 'Coming soon to follow' },

                { name: 'Futory', type: 'Brand', description: 'Future-focused narrative universe.', studios: ['Allmer Comics', 'Allmer Films', 'Allmer Music', 'Allmer Games'], website: 'futory.com', series: ['Futory Saga', 'Futory Cards'] },
                { name: 'Lunyra', type: 'Brand', description: 'Fantasy world building.', studios: ['Allmer Comics', 'Allmer Films', 'Allmer Music', 'Allmer Games'], website: 'lunyra.com' },
                { name: 'American Portrait', type: 'Brand', description: 'Cultural exploration project.', studios: ['Allmer Comics', 'Allmer Films', 'Allmer Music', 'Allmer Games'], series: ['Kissinger', 'Carter'] },
                { name: 'Detective Noname', type: 'Brand', description: 'Mystery franchise.', studios: ['Allmer Comics', 'Allmer Films', 'Allmer Music', 'Allmer Games'] },
                { name: 'Society Review', type: 'Brand', description: 'Social commentary journal.', studios: ['Allmer Journals'], website: 'societyreview.org', series: ['Society Review Magazine', 'Society Review Programs'] },
                { name: 'Chronicle', type: 'Brand', description: 'Historical records and storytelling.', studios: ['Allmer Journals'] },
                { name: 'Seven Wonders', type: 'Brand', description: 'Pure Abstract Strategy Games that are meticilously designed to appeal to both the eye and the intellect.', goal: 'Make them the most recognisable game series of all time.', metrics: ['Site Visitors', 'Products Sold', 'Apps Downloaded'], studios: ['Allmer Games'], website: 'sevenwondersgames.com', series: ['Old Seven Wonders', 'New Seven Wonders'] },
                { name: 'Metropole', type: 'Brand', description: 'Snack brand.', studios: ['Allmer Snacks'] },
                { name: 'Solar-Soda', type: 'Brand', description: 'Snack brand.', studios: ['Allmer Snacks'] },
                { name: 'Believe', type: 'Brand', description: 'Gaming experience.', studios: ['Allmer Games'], website: 'believegame.com' },
                { name: 'Elements', type: 'Brand', description: 'Gaming experience.', studios: ['Allmer Games'] },
                { name: 'Danger', type: 'Brand', description: 'Multistudio brand.', studios: ['Allmer Comics', 'Allmer Films', 'Allmer Music', 'Allmer Games'], website: 'danger.com' },
                { name: 'Colbu', type: 'Brand', description: 'Multistudio brand.', studios: ['Allmer Comics', 'Allmer Films', 'Allmer Music', 'Allmer Games'], website: 'colbu.com' },

                { name: 'Piano Voice', type: 'Concept', description: 'Vocal Range of 5 octaves that is balanced throughout the range.' },
                { name: 'Water Lung', type: 'Concept', description: 'Ability to hold ones breath for at least 5 minutes in a static position.' },
                { name: 'Virtual Sports', type: 'Concept', description: 'Competitive entertainment merging physical sports with immersive digital worlds. Athletes physically move in mixed-reality arenas with VR headsets and body-tracking gear. Developed by Simon Allmer Entertainment, featuring dynamic real-time environments and global broadcasts.' }
            ];

            const eventsData = [
                {
                    name: 'Spielefest Wien',
                    date: 'July 5â€“6, 2025',
                    region: 'Europe',
                    location: 'Vienna, Austria',
                    attendance: '25,000'
                },
                {
                    name: 'Game City Wien',
                    date: 'October 10â€“12, 2025',
                    region: 'Europe',
                    location: 'Vienna, Austria',
                    attendance: '87,000'
                },
                {
                    name: 'Gamescom',
                    date: 'August 20â€“24, 2026',
                    region: 'Europe',
                    location: 'Cologne, Germany',
                    attendance: '370,000'
                },
                {
                    name: 'Spiel',
                    date: 'October 8â€“11, 2026',
                    region: 'Europe',
                    location: 'Essen, Germany',
                    attendance: '209,000'
                },
                {
                    name: 'San Diego Comic-Con',
                    date: 'July 22â€“26, 2026',
                    region: 'North America',
                    location: 'San Diego, USA',
                    attendance: '135,000'
                },
                {
                    name: 'New York Comic Con',
                    date: 'October 8â€“11, 2026',
                    region: 'North America',
                    location: 'New York City, USA',
                    attendance: '200,000+'
                },
                {
                    name: 'Lucca Comics & Games',
                    date: 'Oct 28 â€“ Nov 1, 2026',
                    region: 'Europe',
                    location: 'Lucca, Italy',
                    attendance: '300,000'
                }
            ];

            const catalogData = {
                'Allmer Comics': [
                    { id: 'C001', title: 'Kissinger: A World Destroyed [TBA]' },
                    { id: 'C002', title: 'Carter: The Blood Beneath the Soil [TBA]' },
                    { id: 'C003', title: 'Futory: Dragon Kingdom [TBA]' }
                ],
                'Allmer Films': [
                    { id: 'F001', title: 'Kissinger [TBA]' },
                    { id: 'F002', title: 'Carter [TBA]' },
                    { id: 'F003', title: 'Futory: Dragon Kingdom [TBA]' }
                ],
                'Allmer Music': [
                    { id: 'M001', title: 'American Portrait Score' },
                    { id: 'M002', title: 'Pentamorph' },
                    { id: 'M003', title: 'Sin [TBA]' },
                    { id: 'M004', title: 'Futory Score [TBA]' }
                ],
                'Allmer Games': [
                    { id: 'G001', title: 'Pyramid' },
                    { id: 'G002', title: 'Nectar' },
                    { id: 'G003', title: 'Futory Cards Unity' },
                    { id: 'G004', title: 'Elements' },
                    { id: 'G005', title: 'Gardens' },
                    { id: 'G006', title: 'Temple' },
                    { id: 'G007', title: 'Believe' },
                    { id: 'G008', title: 'Futory Cards Duality' },
                    { id: 'G009', title: 'Detective Noname and the Silent Circle' },
                    { id: 'G010', title: 'Statue' },
                    { id: 'G011', title: 'Mausoleum' },
                    { id: 'G012', title: 'Colossus' },
                    { id: 'G013', title: 'Pharos' },
                    { id: 'G014', title: 'Equilibrium' },
                    { id: 'G015', title: 'Capital' }
                ],
                'Allmer Journals': [
                    { id: 'J001', title: 'Simon Allmer World' },
                    { id: 'J002', title: 'Society Review' },
                    { id: 'J003', title: 'Chronicle' },
                    { id: 'J004', title: 'ACRONYM' }
                ],
                'Allmer Snacks': [
                    { id: 'S001', title: 'Solar-Soda' },
                    { id: 'S002', title: 'Metropole' },
                    { id: 'S003', title: 'Hot Ice [TBA]' }
                ]
            };


            let inventoryData = {
                games: [
                    { name: 'Elements', stockSale: 150, stockGift: 15, price: 12.00 },
                    { name: 'Futory Cards Unity', stockSale: 170, stockGift: 4, price: 25.00 }
                ],
                snacks: [
                    { name: 'Metropole', stockSale: 10, stockGift: 0, price: 10.00 }
                ]
            };

            window.updateStock = function (category, index, type, change) {
                const item = inventoryData[category][index];
                if (type === 'sale') {
                    item.stockSale = Math.max(0, item.stockSale + change);
                } else {
                    item.stockGift = Math.max(0, item.stockGift + change);
                }
                renderAssets(document.getElementById('main-content'));
            }

            // --- FIREBASE SETUP ---
            const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
            let firebaseConfig = {};
            try {
                if (typeof window.__firebase_config !== 'undefined') firebaseConfig = JSON.parse(window.__firebase_config);
            } catch (e) { console.error(e); }

            const ACCOUNT_ID = 'Allmer Bank';
            const LEDGER_PATH = `artifacts/${appId}/public/data/ledger_entries`;
            let db, auth, userId, isAuthReady = false;

            function initFirebase() {
                if (Object.keys(firebaseConfig).length === 0) return;
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        if (currentTab === 'assets') setupLedger();
                    } else {
                        signInAnonymously(auth).catch(console.error);
                    }
                });
            }

            window.showTooltip = function (evt, text) {
                const tooltip = document.getElementById('graph-tooltip');
                tooltip.textContent = text;
                tooltip.style.left = evt.pageX + 10 + 'px';
                tooltip.style.top = evt.pageY - 10 + 'px';
                tooltip.style.opacity = '1';
            };

            window.hideTooltip = function () {
                const tooltip = document.getElementById('graph-tooltip');
                tooltip.style.opacity = '0';
            };

            // --- Map Logic ---
            let worldGeoJson = null;

            async function loadWorldData() {
                if (worldGeoJson) return;
                try {
                    const response = await fetch('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson');
                    worldGeoJson = await response.json();
                    if (document.getElementById('earth-map-container') && currentTab === 'home') {
                        renderEarthMap();
                    }
                } catch (e) {
                    console.error("Failed to load map data", e);
                }
            }

            // Start loading
            loadWorldData();

            window.renderEarthMap = function () {
                const container = document.getElementById('earth-map-container');
                if (!container || !worldGeoJson) return;

                container.innerHTML = '';
                const width = container.clientWidth;
                const height = container.clientHeight;

                const svg = d3.select(container).append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", [0, 0, width, height]);

                // Projection
                const projection = d3.geoNaturalEarth1()
                    .fitSize([width, height], worldGeoJson);

                const path = d3.geoPath().projection(projection);

                const g = svg.append("g");

                // Draw Countries
                g.selectAll("path")
                    .data(worldGeoJson.features)
                    .join("path")
                    .attr("d", path)
                    .attr("fill", d => {
                        const name = d.properties.name;
                        let dataName = name;
                        if (name === 'USA') dataName = 'United States';
                        if (name === 'England') dataName = 'United Kingdom';
                        if (name === 'South Korea') dataName = 'South Korea';

                        const country = countryData[dataName];
                        if (country) {
                            const colors = {
                                'Asia': '#facc15',
                                'Europe': '#22c55e',
                                'America': '#3b82f6',
                            };
                            return colors[country.region] || '#334155';
                        }
                        return '#1e293b';
                    })
                    .attr("stroke", "#0f172a")
                    .attr("stroke-width", 0.5)
                    .style("cursor", "pointer")
                    .on("mouseover", function (event, d) {
                        d3.select(this).attr("opacity", 0.7);
                        let name = d.properties.name;
                        if (name === 'USA') name = 'United States';
                        if (name === 'England') name = 'United Kingdom';
                        window.showTooltip(event, name);
                    })
                    .on("mouseout", function (event, d) {
                        d3.select(this).attr("opacity", 1);
                        window.hideTooltip();
                    })
                    .on("click", (event, d) => {
                        let name = d.properties.name;
                        if (name === 'USA') name = 'United States';
                        if (name === 'England') name = 'United Kingdom';
                        if (countryData[name] && window.showCountryModal) {
                            window.showCountryModal(name);
                        }
                    });

                // Add Flags
                Object.keys(countryData).forEach(cName => {
                    let featureName = cName;
                    if (cName === 'United States') featureName = 'USA';
                    if (cName === 'United Kingdom') featureName = 'England';

                    const feature = worldGeoJson.features.find(f => f.properties.name === featureName);
                    if (feature) {
                        const [x, y] = path.centroid(feature);
                        if (!isNaN(x) && !isNaN(y)) {
                            svg.append("text")
                                .attr("x", x)
                                .attr("y", y)
                                .attr("text-anchor", "middle")
                                .attr("dy", "0.3em")
                                .style("font-size", "14px")
                                .style("pointer-events", "none")
                                .style("opacity", "0.8")
                                .text(countryData[cName].flag);
                        }
                    }
                });
            };

            // --- APP LOGIC ---
            let currentTab = 'home';

            window.switchTab = function (tabName) {
                currentTab = tabName;

                // Ensure sub-page is closed when switching tabs
                closeSubPage();

                // Update Nav
                document.querySelectorAll('.nav-tab').forEach(btn => {
                    btn.classList.remove('active');
                    const onclick = btn.getAttribute('onclick');
                    if (onclick && onclick.includes(tabName)) {
                        btn.classList.add('active');
                    }
                    // Handle Knowledge Dropdown active state
                    if (btn.innerText.includes('Knowledge') && (tabName === 'dictionary' || tabName === 'processes')) {
                        btn.classList.add('active');
                    }
                });

                // Render
                const main = document.getElementById('main-content');
                main.style.opacity = '0';
                setTimeout(() => {
                    if (tabName === 'home') {
                        renderHome(main);
                        setTimeout(window.renderEarthMap, 100);
                    }
                    else if (tabName === 'projects') renderProjects(main);
                    else if (tabName === 'studios') renderStudios(main);
                    else if (tabName === 'products') renderProducts(main);
                    else if (tabName === 'brands') renderBrands(main);
                    else if (tabName === 'events') renderEvents(main);
                    else if (tabName === 'assets') renderAssets(main);
                    else if (tabName === 'dictionary') renderDictionary(main);
                    else if (tabName === 'processes') renderProcesses(main);

                    main.classList.remove('animate-slide-up');
                    void main.offsetWidth; // trigger reflow
                    main.classList.add('animate-slide-up');
                    main.style.opacity = '1';
                }, 200);
            };

            function renderHome(container) {
                container.innerHTML = `
                <!-- Header Section -->
                <div class="flex justify-center mb-12">
                    <div class="bg-surface-highlight border border-slate-600 px-10 py-6 rounded-xl shadow-2xl text-center max-w-3xl w-full">
                        <h2 class="text-2xl font-display font-medium text-white leading-relaxed">Committed to creative excellence,<br>Simon Allmer</h2>
                    </div>
                </div>

                <!-- Divisions Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-20 max-w-5xl mx-auto">
                    ${Object.entries(subdivisions).map(([title, items]) => `
                        <div class="dashboard-card p-6 text-center group cursor-pointer" onclick="toggleDivision(this)">
                            <h3 class="text-xl font-bold text-white mb-1">${title}</h3>
                            <p class="text-sm text-slate-400 mb-4 group-hover:text-sa-blue transition-colors">(Click to Expand â–¾)</p>
                            
                            <div class="hidden space-y-2 mb-4 text-left bg-slate-950/50 p-4 rounded-lg border border-white/5 animate-fade-in">
                                ${items.map(item => `<div class="text-slate-300 hover:text-white cursor-pointer py-1 border-b border-white/5 last:border-0" onclick="event.stopPropagation(); showModal('${item}')">${item}</div>`).join('')}
                            </div>

                            ${title === 'Allmer Studios' ? `
                                <button class="mt-2 text-xs font-bold text-sa-blue hover:text-white border border-sa-blue/30 hover:border-white rounded px-3 py-1 transition-all" onclick="event.stopPropagation(); switchTab('studios')">
                                    View Studios
                                </button>
                            ` : ''}
                            ${title === 'Allmer Brands' ? `
                                <button class="mt-2 text-xs font-bold text-sa-blue hover:text-white border border-sa-blue/30 hover:border-white rounded px-3 py-1 transition-all" onclick="event.stopPropagation(); switchTab('brands')">
                                    View Brands
                                </button>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>

                <!-- Project Tracker Section Removed -->

                <!-- Global Operations Header -->
                <div class="flex justify-center mb-8">
                     <div class="bg-surface-highlight border border-slate-600 px-12 py-3 rounded-lg shadow-lg text-center">
                        <h2 class="text-xl font-display font-bold text-white">Global Operations</h2>
                    </div>
                </div>

                <!-- Continent Rows -->
                <div class="max-w-7xl mx-auto space-y-12 mb-16 px-4">
                    ${['Europe', 'America', 'Asia'].map(region => {
                    // Filter Data
                    const regionCountries = Object.entries(countryData)
                        .filter(([_, d]) => d.region === region)
                        .map(([name, data]) => ({ name, data }));

                    if (regionCountries.length === 0) return '';

                    // Calculate Stats
                    // 1. Total Population
                    let totalPopMillions = 0;
                    regionCountries.forEach(({ data }) => {
                        const match = data.population.match(/([\d.]+)\s*(M|B)/i);
                        if (match) {
                            let val = parseFloat(match[1]);
                            if (match[2].toUpperCase().startsWith('B')) val *= 1000;
                            totalPopMillions += val;
                        }
                    });

                    let popDisplay = '';
                    if (totalPopMillions >= 1000) popDisplay = (totalPopMillions / 1000).toFixed(2) + ' Billion';
                    else popDisplay = totalPopMillions.toFixed(1) + ' Million';

                    // 2. Largest Operating Cities
                    const operatingCities = [];
                    regionCountries.forEach(({ name: cName, data }) => {
                        if (data.cities) {
                            data.cities.forEach(city => {
                                const cityStat = data.largestCities.find(lc => lc.name === city);
                                if (cityStat) {
                                    let items = cityStat.pop.match(/([\d.]+)/);
                                    let val = items ? parseFloat(items[1]) : 0;
                                    // Adjust scale if needed (assuming all satisfy M unless specified)
                                    operatingCities.push({ name: city, pop: cityStat.pop, val, country: cName });
                                }
                            });
                        }
                    });
                    operatingCities.sort((a, b) => b.val - a.val);

                    const displayRegion = region === 'America' ? 'Americas' : region;

                    return `
                            <div class="flex flex-col xl:flex-row gap-6">
                                <!-- Stats Sidebar (Clickable) -->
                                <div class="xl:w-64 flex-shrink-0">
                                    <div class="bg-surface-highlight border border-slate-700 rounded-xl p-6 h-full cursor-pointer hover:border-sa-blue transition-all group relative overflow-hidden" onclick="this.classList.toggle('active'); this.querySelector('.stats-content').classList.toggle('hidden');">
                                        <div class="flex justify-between items-center mb-2">
                                            <h3 class="text-2xl font-display font-bold text-white group-hover:text-sa-blue transition-colors">${displayRegion}</h3>
                                            <span class="text-slate-500 transform transition-transform group-hover:rotate-180">â–¾</span>
                                        </div>
                                        <p class="text-slate-400 text-sm mb-0">View Statistics</p>
                                        
                                        <!-- Stats Content (Hidden by default) -->
                                        <div class="stats-content hidden mt-6 space-y-6 animate-fade-in border-t border-slate-600 pt-4">
                                            <div>
                                                <p class="text-xs text-slate-500 uppercase font-bold text-sa-blue">Total Population</p>
                                                <p class="text-2xl font-mono text-white font-bold">${popDisplay}</p>
                                                <p class="text-xs text-slate-400 italic mt-1">Across active markets</p>
                                            </div>
                                            <div>
                                                <p class="text-xs text-slate-500 uppercase font-bold text-sa-blue mb-3">Largest Hubs</p>
                                                <ul class="space-y-3">
                                                    ${operatingCities.slice(0, 3).map(c => `
                                                        <li class="text-sm">
                                                            <div class="flex justify-between items-center">
                                                                <span class="text-white font-bold">${c.name}</span>
                                                                <span class="text-xs font-mono text-green-400">${c.pop}</span>
                                                            </div>
                                                            <span class="text-xs text-slate-500 block">${c.country}</span>
                                                        </li>
                                                    `).join('')}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Country Grid -->
                                <div class="flex-grow">
                                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                        ${regionCountries.map(({ name, data }) => `
                                            <button class="country-btn flex flex-col items-center justify-center p-3 rounded-xl border-status-${data.presenceLevel} status-${data.presenceLevel} h-32 w-full bg-surface hover:bg-surface-highlight transition-all" onclick="showCountryModal('${name}')">
                                                <span class="text-4xl mb-3 filter drop-shadow-lg transform transition-transform group-hover:scale-110">${data.flag}</span>
                                                <span class="text-xs text-slate-300 font-medium leading-tight text-center px-1">${name}</span>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                }).join('')}
                </div>

                <!-- Earth Map Section -->
                <div class="max-w-7xl mx-auto mb-16 px-4">
                    <div class="bg-surface border border-slate-700 rounded-2xl p-8 shadow-2xl relative overflow-hidden">
                        <!-- Glow Effect -->
                        <div class="absolute -top-24 -right-24 w-64 h-64 bg-blue-500/10 rounded-full blur-[80px]"></div>
                        
                        <div class="flex flex-col xl:flex-row gap-8 relative z-10">
                            <!-- Left: Stats -->
                            <div class="xl:w-1/3 text-center xl:text-left flex flex-col justify-center">
                                <h3 class="text-3xl font-display font-bold text-white mb-2">Earth</h3>
                                <p class="text-slate-400 mb-6 uppercase tracking-widest text-sm">Global Presence</p>
                                
                                ${(() => {
                        let totalOperatingMillions = 0;
                        Object.entries(countryData).forEach(([_, d]) => {
                            const match = d.population.match(/([\d.]+)\s*(M|B)/i);
                            if (match) {
                                let val = parseFloat(match[1]);
                                if (match[2].toUpperCase().startsWith('B')) val *= 1000;
                                totalOperatingMillions += val;
                            }
                        });
                        const earthTotalMillions = 8100;
                        const percent = ((totalOperatingMillions / earthTotalMillions) * 100).toFixed(1);
                        const operatingDisplay = totalOperatingMillions >= 1000
                            ? (totalOperatingMillions / 1000).toFixed(2) + ' Billion'
                            : totalOperatingMillions.toFixed(1) + ' Million';

                        return `
                                        <div class="space-y-4 mb-4">
                                            <div>
                                                <p class="text-5xl font-mono font-bold text-white mb-2">${operatingDisplay}</p>
                                                <p class="text-slate-400">Total Operating Population</p>
                                            </div>
                                            
                                            <div class="inline-flex items-center gap-3 bg-slate-900/50 px-4 py-2 rounded-full border border-slate-700 justify-center xl:justify-start">
                                                <span class="text-sa-blue font-bold text-xl">${percent}%</span>
                                                <span class="text-xs text-slate-500 uppercase font-bold">of Global Population</span>
                                            </div>
                                        </div>
                                    `;
                    })()}
                            </div>

                            <!-- Right: Map -->
                            <div class="flex-grow min-h-[400px] xl:min-h-[500px] rounded-xl overflow-hidden bg-slate-900/30 border border-slate-800 relative group" id="earth-map-container">
                                <!-- D3 Map will render here -->
                                <div class="absolute inset-0 flex items-center justify-center text-slate-500">
                                    Loading World Map...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inline Script for Pie Chart logic removed from string template to avoid parser crash -->


        <!-- Legend -->
        <div class="mt-8 bg-surface-highlight/50 border border-slate-800 rounded-xl p-6 max-w-4xl mx-auto">
            <h4 class="text-lg font-bold text-slate-200 mb-4">Presence Legend</h4>
            <div class="flex flex-col md:flex-row justify-center gap-6 text-sm">
                <div class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded-full border-2 border-status-red bg-red-900/20"></div>
                    <span class="text-status-red font-semibold">Red: No Physical Presence (Digital/Partners Only)</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded-full border-2 border-status-yellow bg-yellow-900/20"></div>
                    <span class="text-status-yellow font-semibold">Yellow: Active Partners</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded-full border-2 border-status-green bg-green-900/20"></div>
                    <span class="text-status-green font-semibold">Green: Physical Presence</span>
                </div>
            </div>
        </div>
        `;
            }

            function renderProjects(container) {
                container.innerHTML = `
        <div class="max-w-4xl mx-auto mt-8">
            <h2 class="text-3xl font-bold text-sa-blue mb-10 text-center">Project Tracker</h2>

            <div class="space-y-8">
                ${projectData.map(project => `
                <div class="dashboard-card p-6">
                    <div
                        class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-slate-700 pb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-white">${project.title}</h3>
                            ${project.subtitle ? `<p class="text-slate-400 text-sm">${project.subtitle}</p>` : ''}
                            <p class="text-sa-blue text-sm mt-1">Studio: <span
                                    class="text-white">${project.studio}</span></p>
                        </div>
                        <div class="mt-2 md:mt-0 text-right">
                            <span class="text-xs text-slate-500 uppercase font-bold">Estimated Budget</span>
                            <p class="text-status-green font-mono font-bold">${project.budget}</p>
                        </div>
                    </div>

                    <!-- Kanban Stepper -->
                    <div class="relative">
                        <div class="absolute top-1/2 left-0 w-full h-1 bg-slate-800 -translate-y-1/2 rounded"></div>
                        <div class="relative z-10 flex justify-between">
                            ${project.steps.map((step, index) => {
                    let statusColor = 'bg-slate-800 border-slate-600 text-slate-500'; // Pending
                    let icon = index + 1;

                    if (step.status === 'active') {
                        statusColor = 'bg-sa-darkblue border-sa-blue text-white shadow-[0_0_15px_rgba(96,165,250,0.5)]';
                    } else if (step.status === 'done') {
                        statusColor = 'bg-status-green border-green-400 text-white';
                        icon = 'âœ“';
                    }

                    return `
                            <div class="flex flex-col items-center group flex-1">
                                <div
                                    class="w-10 h-10 rounded-full flex items-center justify-center border-2 ${statusColor} font-bold transition-all mb-3 z-10 bg-surface">
                                    ${icon}
                                </div>
                                <div class="text-center">
                                    <p
                                        class="text-sm font-bold ${step.status === 'active' ? 'text-white' : 'text-slate-400'}">
                                        ${step.name}</p>
                                    <p class="text-xs text-slate-500 max-w-[120px] mx-auto">${step.detail}</p>
                                    ${step.progress ? `<span
                                        class="inline-block mt-1 px-2 py-0.5 rounded text-[10px] font-bold bg-slate-800 text-sa-blue border border-slate-700">${step.progress}</span>`
                            : ''}
                                </div>
                            </div>
                            `;
                }).join('')}
                        </div>
                    </div>
                </div>
                `).join('')}
            </div>
        </div>
        `;
            }

            function renderStudios(container) {
                container.innerHTML = `
        \u003cdiv class=\"max-w-5xl mx-auto mt-8\"\u003e
        \u003ch2 class=\"text-3xl font-bold text-sa-blue mb-10 text-center\"\u003eAllmer Studios\u003c/h2\u003e

        \u003cdiv class=\"grid grid-cols-1 md:grid-cols-2 gap-8\"\u003e
        ${Object.entries(studiosData).map(([studioName, studio]) => {
                    // Create subtle background color from the studio's color
                    const hexToRgb = (hex) => {
                        const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);
                        return result ? {
                            r: parseInt(result[1], 16),
                            g: parseInt(result[2], 16),
                            b: parseInt(result[3], 16)
                        } : null;
                    };
                    const rgb = hexToRgb(studio.color);
                    const bgColor = rgb ? `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)` : 'rgba(255, 255, 255, 0.05)';
                    const borderColor = rgb ? `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)` : 'rgba(255, 255, 255, 0.1)';

                    return `
        \u003cdiv class=\"dashboard-card p-6 hover:transform hover:-translate-y-1 transition-all duration-300\"
        style=\"background-color: ${bgColor}; border-color: ${borderColor};\"\u003e
        \u003c!-- Studio Header --\u003e
        \u003cdiv class=\"flex justify-between items-start mb-4 border-b border-slate-700 pb-3\"\u003e
        \u003ch3 class=\"text-2xl font-bold text-white\"\u003e${studioName}\u003c/h3\u003e
        \u003ca href=\"https://${studio.website}\" target=\"_blank\" class=\"text-xs font-bold px-3 py-1 rounded
        transition-all hover:scale-105\" style=\"color: ${studio.color}; border: 1px solid ${studio.color};\"\u003e
        ${studio.website} â†—
        \u003c/a\u003e
        </a>
        <!-- Footer Spacer for Squarespace -->
        <div class="h-40"></div>
    </div>

    <!-- Products -->
    <div class="mb-4">
        <h4 class="text-xs uppercase font-bold text-slate-400 mb-2 tracking-wider">Products</h4>
        <div class="flex flex-wrap gap-2">
            ${studio.products.slice(0, 3).map(product => `
            <span class="px-3 py-1 rounded text-sm font-medium text-white"
                style="background-color: ${studio.color}20; border: 1px solid ${studio.color}40;">
                ${product}
            </span>
            `).join('')}
        </div>
    </div>

    ${studio.technicalInsight ? `
    <!-- Technical Insight -->
    <div class="mb-4">
        <h4 class="text-xs uppercase font-bold text-slate-400 mb-2 tracking-wider">Technical Insight</h4>
        <p class="text-slate-300 text-sm italic leading-relaxed">${studio.technicalInsight}</p>
    </div>
    ` : ''}

    ${studio.partners.length > 0 ? `
    <!-- Partners -->
    <div class="border-t border-slate-700 pt-3 mt-4">
        <h4 class="text-xs uppercase font-bold text-slate-400 mb-2 tracking-wider">Partners</h4>
        <ul class="list-disc pl-5 text-slate-300 text-sm space-y-1">
            ${studio.partners.map(partner => {
                        if (typeof partner === 'string') {
                            return `<li>${partner}</li>`;
                        } else if (partner.url) {
                            return `<li><a href="${partner.url}" target="_blank"
                    class="text-sa-blue hover:text-white transition-colors">${partner.name} â†—</a></li>`;
                        }
                        return `<li>${partner.name}</li>`;
                    }).join('')}
        </ul>
    </div>
    ` : ''}

    ${studio.assets && studio.assets.length > 0 ? `
    <!-- Assets -->
    <div class="border-t border-slate-700 pt-3 mt-4">
        <h4 class="text-xs uppercase font-bold text-slate-400 mb-2 tracking-wider">Assets</h4>
        <div class="flex flex-wrap gap-2">
            ${studio.assets.map(asset => `
            <a href="${asset.url}" target="_blank"
                class="px-3 py-1.5 rounded text-sm font-medium transition-all hover:scale-105"
                style="color: ${studio.color}; border: 1px solid ${studio.color}; background-color: ${studio.color}15;">
                ${asset.name} â†—
            </a>
            `).join('')}
        </div>
    </div>
    ` : ''}

    ${studio.externalDatabases && studio.externalDatabases.length > 0 ? `
    <!-- External Databases -->
    <div class="border-t border-slate-700 pt-3 mt-4">
        <h4 class="text-xs uppercase font-bold text-slate-400 mb-2 tracking-wider">External Databases</h4>
        <div class="flex flex-wrap gap-2">
            ${studio.externalDatabases.map(db => `
            <a href="${db.url}" target="_blank"
                class="px-3 py-1.5 rounded text-sm font-medium transition-all hover:scale-105"
                style="color: ${studio.color}; border: 1px solid ${studio.color}; background-color: ${studio.color}15;">
                ${db.name} â†—
            </a>
            `).join('')}
        </div>
    </div>
    ` : ''}
    </div>
    `}).join('')}
    </div>
    </div>
    `;
            }


            function renderPartners(container) {
                // Function to calculate age from birthday
                const calculateAge = (birthdayStr) => {
                    const birthday = new Date(birthdayStr);
                    const today = new Date();
                    let age = today.getFullYear() - birthday.getFullYear();
                    const monthDiff = today.getMonth() - birthday.getMonth();
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthday.getDate())) { age--; } return age;
                };
                container.innerHTML = ` <div class="max-w-4xl mx-auto mt-8">
        <h2 class="text-3xl font-bold text-sa-blue mb-10 text-center">Network</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            ${partnersData.map(partner => {
                    const age = calculateAge(partner.birthday);
                    return `
            <div
                class="dashboard-card p-6 flex items-center space-x-6 hover:bg-slate-800/50 transition-colors cursor-default">
                <div
                    class="w-20 h-20 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-2xl font-bold text-white border border-slate-600 shadow-lg">
                    ${partner.name.split(' ').map(n => n[0]).join('')}
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-white">${partner.name}</h3>
                    <p class="text-sa-blue text-sm font-medium mb-2">${partner.role}</p>
                    <div class="text-xs text-slate-400 space-y-1">
                        <div>
                            <span class="font-bold uppercase text-slate-500">Birthday:</span>
                            ${partner.birthday} (Age ${age})
                        </div>
                        <div>
                            <span class="font-bold uppercase text-slate-500">Projects:</span>
                            ${partner.projects.join(', ')}
                        </div>
                    </div>
                </div>
            </div>
            `}).join('')}
        </div>

        <div class="text-center mt-8">
            <p class="text-slate-400 italic text-lg">Only A-Players</p>
        </div>
        </div>
        `;
            }

            function renderAssets(container) {
                // Calculate Totals
                const getCategoryTotal = (items) => items.reduce((sum, item) => sum + (item.stockSale * item.price), 0);
                const gamesTotal = getCategoryTotal(inventoryData.games);
                const snacksTotal = getCategoryTotal(inventoryData.snacks);

                const equipmentData = [
                    {
                        id: 'mac-mini', name: 'Mac mini', subDetails: '', details: '', bought: 2026, lifespan: 8, price: 1500, color:
                            '#60a5fa'
                    },
                    {
                        id: 'ipad-pro', name: 'iPad Pro', subDetails: '', details: '', bought: 2026, lifespan: 5, price: 1000, color:
                            '#34d399'
                    },
                    {
                        id: 'alpha-6400', name: 'Sony Alpha 6400', subDetails: 'Released 2019', details: 'Lense: 16-50 mm', bought:
                            2026, lifespan: 10, price: 1149, color: '#facc15'
                    },
                    {
                        id: 'rx0ii', name: 'Sony RX0II', subDetails: 'Released 2019', details: 'Lense: 35mm', pros: '+ Extremely small and mobile', cons: '- Not good in low light', bought: 2019, lifespan: 10, price: 799, color: '#f472b6'
                    }
                ];

                window.highlightGraph = function (id) {
                    equipmentData.forEach(item => {
                        const el = document.getElementById('path-' + item.id);
                        if (el) {
                            el.setAttribute('stroke-opacity', '0.3');
                            el.setAttribute('stroke-width', '2');
                            el.style.filter = 'none';
                        }
                        const row = document.getElementById('row-' + item.id);
                        if (row) row.classList.remove('bg-slate-800');
                    });

                    const active = document.getElementById('path-' + id);
                    if (active) {
                        active.setAttribute('stroke-opacity', '1');
                        active.setAttribute('stroke-width', '4');
                        active.style.filter = 'drop-shadow(0 0 8px ' + active.getAttribute('stroke') + ')';
                    }
                    const activeRow = document.getElementById('row-' + id);
                    if (activeRow) activeRow.classList.add('bg-slate-800');
                };

                const generatePath = (item) => {
                    let path = "";
                    for (let year = 2026; year <= 2036; year++) {
                        let age = year - item.bought; let val = item.price * (1 - age / item.lifespan);
                        val = Math.max(0, Math.min(item.price, val));
                        // Y Axis: 0=255, 2000=55 -> Range 200px for 2000 units -> 1 unit = 0.1px
                        const x = 50 + (year - 2026) * 50;
                        const y = 255 - (val / 10);

                        if (year === 2026) path += `M${x},${y}`;
                        else path += ` L${x},${y}`;
                    }
                    return path;
                };

                container.innerHTML = `
            <div class="max-w-6xl mx-auto mt-10 space-y-12">
                <h2 class="text-3xl font-bold text-sa-blue mb-8 text-center">Assets & Inventory</h2>

                <!-- Liquid Assets -->
                <div class="dashboard-card p-8">
                    <div class="flex justify-between items-start border-b border-slate-700 pb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-white mb-1">Allmer Bank</h3>
                            <p class="text-slate-400">Liquid Capital</p>
                        </div>
                        <div class="text-right">
                            <span class="block text-4xl font-mono font-bold text-status-green">â‚¬10.00</span>
                            <span class="text-sm text-slate-500">Total Balance</span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div id="ledger-list" class="text-sm text-slate-400 space-y-1">
                            <div class="flex justify-between py-2 border-b border-slate-800">
                                <span class="text-slate-300">Initial Capital Injection</span>
                                <span class="text-sa-blue font-mono">10.00â‚¬</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Equipment & Depreciation -->
                <div class="dashboard-card p-8">
                    <h3 class="text-xl font-bold text-white mb-6">Equipment & Depreciation (Planned 2026)</h3>

                    <div class="flex flex-col xl:flex-row gap-8">
                        <!-- Graph -->
                        <div class="flex-1">
                            <div class="p-4 bg-slate-900/50 rounded-xl border border-slate-800 relative">
                                <svg viewBox="0 0 600 300" class="w-full h-auto font-mono text-xs">
                                    <!-- Grid Lines -->
                                    <line x1="50" y1="255" x2="550" y2="255" stroke="#334155" stroke-width="1" />
                                    <line x1="50" y1="55" x2="550" y2="55" stroke="#334155" stroke-width="1"
                                        stroke-dasharray="4" />

                                    <!-- Axes Labels -->
                                    <text x="40" y="260" fill="#94a3b8" text-anchor="end">0</text>
                                    <text x="40" y="210" fill="#94a3b8" text-anchor="end">500</text>
                                    <text x="40" y="160" fill="#94a3b8" text-anchor="end">1000</text>
                                    <text x="40" y="110" fill="#94a3b8" text-anchor="end">1500</text>
                                    <text x="40" y="60" fill="#94a3b8" text-anchor="end">2000</text>

                                    <!-- Years -->
                                    ${[...Array(11)].map((_, i) => `<text x="${50 + i * 50}" y="280" fill="#94a3b8"
                                        text-anchor="middle">${2026 + i}</text>`).join('')}

                                    <!-- Paths -->
                                    ${equipmentData.map(item => `
                                    <path id="path-${item.id}" d="${generatePath(item)}" stroke="${item.color}"
                                        stroke-width="2" stroke-opacity="0.3" fill="none" stroke-linecap="round"
                                        stroke-linejoin="round" class="transition-all duration-300" />
                                    `).join('')}
                                </svg>
                            </div>
                            <p class="text-xs text-slate-500 mt-2 text-center italic">Click items in the table to
                                highlight depreciation curve</p>
                        </div>

                        <!-- Table -->
                        <div class="flex-1 overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr
                                        class="bg-slate-900/50 text-slate-400 text-sm uppercase tracking-wider border-b border-slate-700">
                                        <th class="p-4 font-semibold">Item</th>
                                        <th class="p-4 font-semibold">Buying Year</th>
                                        <th class="p-4 font-semibold">Age</th>
                                        <th class="p-4 font-semibold">Lifespan</th>
                                        <th class="p-4 font-semibold text-right">Initial Value</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-800 text-slate-300 text-sm">
                                    ${equipmentData.map(item => {
                    const age = Math.max(0, new Date().getFullYear() - item.bought);
                    return `
                                    <tr id="row-${item.id}"
                                        class="cursor-pointer hover:bg-slate-800/50 transition-colors"
                                        onclick="highlightGraph('${item.id}')">
                                        <td class="p-4">
                                            <div class="font-bold text-white flex items-center gap-2">
                                                <span class="w-3 h-3 rounded-full"
                                                    style="background-color: ${item.color}"></span>
                                                ${item.name}
                                            </div>
                                            ${item.subDetails ? `<div class="text-xs text-slate-500">${item.subDetails}
                                            </div>` : ''}
                                            ${item.details ? `<div class="text-xs mt-1">${item.details}</div>` : ''}
                                            ${item.pros ? `<div class="text-xs text-green-400 mt-1">${item.pros}</div>`
                            : ''}
                                            ${item.cons ? `<div class="text-xs text-red-400">${item.cons}</div>` : ''}
                                        </td>
                                        <td class="p-4">${item.bought}</td>
                                        <td class="p-4">${age} years</td>
                                        <td class="p-4">${item.lifespan} years</td>
                                        <td class="p-4 text-right font-mono">â‚¬${item.price.toLocaleString(undefined, {
                                minimumFractionDigits: 2, maximumFractionDigits: 2
                            })}</td>
                                    </tr>
                                    `;
                }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Inventory -->
                <div class="space-y-6">
                    <div class="flex justify-between items-end">
                        <h3 class="text-2xl font-bold text-white">Inventory</h3>
                        <span
                            class="text-sm text-slate-400 bg-slate-900 px-3 py-1 rounded-full border border-slate-700">ðŸ“
                            Vienna, Austria</span>
                    </div>

                    <!-- Allmer Games Inventory -->
                    <div class="dashboard-card overflow-hidden bg-green-900/10 border-green-900/30">
                        <div class="bg-slate-900/50 p-4 border-b border-slate-700">
                            <h4 class="font-bold text-lg text-white">Allmer Games Inventory</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr
                                        class="bg-slate-900/30 text-slate-400 text-xs uppercase tracking-wider border-b border-slate-800">
                                        <th class="p-4 font-semibold">Name</th>
                                        <th class="p-4 font-semibold text-center">Stock (For Sale)</th>
                                        <th class="p-4 font-semibold text-center">Stock (For Gifts)</th>
                                        <th class="p-4 font-semibold text-right">Total Worth</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-800 text-slate-300 text-sm">
                                    ${inventoryData.games.map((item, i) => `
                                    <tr>
                                        <td class="p-4 font-medium text-white">${item.name}</td>
                                        <td class="p-4 text-center">
                                            <div class="flex items-center justify-center gap-2">
                                                <button onclick="updateStock('games', ${i}, 'sale', -1)"
                                                    class="text-slate-500 hover:text-white px-1">-</button>
                                                <span class="w-8 text-center">${item.stockSale}</span>
                                                <button onclick="updateStock('games', ${i}, 'sale', 1)"
                                                    class="text-slate-500 hover:text-white px-1">+</button>
                                            </div>
                                        </td>
                                        <td class="p-4 text-center">
                                            <div class="flex items-center justify-center gap-2">
                                                <button onclick="updateStock('games', ${i}, 'gift', -1)"
                                                    class="text-slate-500 hover:text-white px-1">-</button>
                                                <span class="w-8 text-center">${item.stockGift}</span>
                                                <button onclick="updateStock('games', ${i}, 'gift', 1)"
                                                    class="text-slate-500 hover:text-white px-1">+</button>
                                            </div>
                                        </td>
                                        <td class="p-4 text-right font-mono">â‚¬${(item.stockSale *
                        item.price).toFixed(2)}</td>
                                    </tr>
                                    `).join('')}
                                    <tr class="bg-slate-800/30 font-bold text-white">
                                        <td class="p-4" colspan="3">TOTAL</td>
                                        <td class="p-4 text-right font-mono">â‚¬${gamesTotal.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="p-3 bg-slate-900/30 text-xs text-slate-500 text-right">
                            Last Stocktaking: 11.09.2025
                        </div>
                    </div>

                    <!-- Allmer Snacks Inventory -->
                    <div class="dashboard-card overflow-hidden bg-pink-900/10 border-pink-900/30">
                        <div class="bg-slate-900/50 p-4 border-b border-slate-700">
                            <h4 class="font-bold text-lg text-white">Allmer Snacks Inventory</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr
                                        class="bg-slate-900/30 text-slate-400 text-xs uppercase tracking-wider border-b border-slate-800">
                                        <th class="p-4 font-semibold">Name</th>
                                        <th class="p-4 font-semibold text-center">Stock (For Sale)</th>
                                        <th class="p-4 font-semibold text-center">Stock (For Gifts)</th>
                                        <th class="p-4 font-semibold text-right">Total Worth</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-800 text-slate-300 text-sm">
                                    ${inventoryData.snacks.map((item, i) => `
                                    <tr>
                                        <td class="p-4 font-medium text-white">${item.name}</td>
                                        <td class="p-4 text-center">
                                            <div class="flex items-center justify-center gap-2">
                                                <button onclick="updateStock('snacks', ${i}, 'sale', -1)"
                                                    class="text-slate-500 hover:text-white px-1">-</button>
                                                <span class="w-8 text-center">${item.stockSale}</span>
                                                <button onclick="updateStock('snacks', ${i}, 'sale', 1)"
                                                    class="text-slate-500 hover:text-white px-1">+</button>
                                            </div>
                                        </td>
                                        <td class="p-4 text-center">
                                            <div class="flex items-center justify-center gap-2">
                                                <button onclick="updateStock('snacks', ${i}, 'gift', -1)"
                                                    class="text-slate-500 hover:text-white px-1">-</button>
                                                <span class="w-8 text-center">${item.stockGift}</span>
                                                <button onclick="updateStock('snacks', ${i}, 'gift', 1)"
                                                    class="text-slate-500 hover:text-white px-1">+</button>
                                            </div>
                                        </td>
                                        <td class="p-4 text-right font-mono">â‚¬${(item.stockSale *
                                item.price).toFixed(2)}</td>
                                    </tr>
                                    `).join('')}
                                    <tr class="bg-slate-800/30 font-bold text-white">
                                        <td class="p-4" colspan="3">TOTAL</td>
                                        <td class="p-4 text-right font-mono">â‚¬${snacksTotal.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            `;
                if (isAuthReady) setupLedger();
            }

            function renderProducts(container) {
                const colors = {
                    'Allmer Comics': 'bg-red-900/20 border-red-500/20',
                    'Allmer Films': 'bg-blue-900/20 border-blue-500/20',
                    'Allmer Music': 'bg-yellow-900/20 border-yellow-500/20',
                    'Allmer Games': 'bg-green-900/20 border-green-500/20',
                    'Allmer Journals': 'bg-amber-950/40 border-amber-700/20',
                    'Allmer Snacks': 'bg-pink-900/20 border-pink-500/20'
                };

                container.innerHTML = `
            <div class="max-w-4xl mx-auto mt-8">
                <h2 class="text-3xl font-bold text-sa-blue mb-10 text-center">Products</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    ${Object.entries(catalogData).map(([category, items]) => `
                    <div class="dashboard-card p-6 ${colors[category] || ''}">
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-2">${category}</h3>
                        <ul class="space-y-2">
                            ${items.map(item => {
                    const productSlug = item.title.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g,
                        '');
                    return `
                            <li>
                                <a href="http://simonallmer.com/${productSlug}" target="_blank" class="block group">
                                    <span
                                        class="text-slate-500 font-mono text-xs mr-2 group-hover:text-sa-blue transition-colors">${item.id}</span>
                                    <span
                                        class="text-slate-300 group-hover:text-white transition-colors">${item.title}</span>
                                </a>
                            </li>
                            `}).join('')}
                        </ul>
                    </div>
                    `).join('')}
                </div>
            </div>
            `;
            }


            function renderEvents(container) {
                // Sort events by date
                const sortedEvents = [...eventsData].sort((a, b) => {
                    const parseDate = (dateStr) => {
                        // Extract "Month Day" and "Year"
                        // Handle format "August 20â€“24, 2026" -> "August 20, 2026"
                        // Split by comma to get year
                        const parts = dateStr.split(',');
                        if (parts.length < 2) return new Date(0); const year = parts[1].trim(); // Get the first part "August 20â€“24"
                        const datePart = parts[0].trim(); // Split by space to get Month const dateSubParts=datePart.split(' ');
                        const month = dateSubParts[0];
                        // Get the day part, taking only the start day if there's a range 
                        // Regex to match the first number
                        const dayMatch = dateSubParts[1].match(/(\d+)/);
                        const day = dayMatch ? dayMatch[1] : '1';
                        return new Date(`${month} ${day}, ${year}`);
                    }; return parseDate(a.date) - parseDate(b.date);
                });
                container.innerHTML = ` <div class="max-w-4xl mx-auto mt-8">
                <h2 class="text-3xl font-bold text-sa-blue mb-10 text-center">Upcoming Events</h2>

                <div class="grid grid-cols-1 gap-6">
                    ${sortedEvents.map(event => `
                    <div
                        class="dashboard-card p-6 flex flex-col md:flex-row justify-between items-center hover:bg-slate-800/50 transition-all">
                        <div class="mb-4 md:mb-0">
                            <h3 class="text-2xl font-bold text-white mb-2">${event.name}</h3>
                            <div class="flex flex-wrap gap-4 text-sm text-slate-400">
                                <span class="flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    ${event.date}
                                </span>
                                <span class="flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                                        </path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    ${event.location} (${event.region})
                                </span>
                            </div>
                        </div>
                        <div
                            class="text-center md:text-right bg-slate-900/50 p-3 rounded-lg border border-slate-700 min-w-[140px]">
                            <span class="block text-xs text-slate-500 uppercase font-bold tracking-wider">Est.
                                Attendance</span>
                            <span class="block text-xl font-mono font-bold text-sa-blue">${event.attendance}</span>
                        </div>
                    </div>
                    `).join('')}
                </div>
                </div>
                `;
            }

            function renderBrands(container) {
                const brands = dictionaryData.filter(item => item.type === 'Brand');
                const multiStudioBrands = brands.filter(b => b.studios && b.studios.length > 1);
                const singleStudioBrands = brands.filter(b => !b.studios || b.studios.length <= 1); const
                    renderBrandCard = (brand) => `
                    <div class="dashboard-card p-6 flex flex-col justify-between hover:bg-slate-800/50 transition-all">
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-2xl font-bold text-white">${brand.name}</h3>
                                ${brand.website ? `<a href="https://${brand.website}" target="_blank"
                                    class="text-xs text-sa-blue hover:text-white border border-sa-blue/30 hover:border-white rounded px-2 py-1 transition-all">${brand.website}
                                    â†—</a>` : ''}
                            </div>
                            <p class="text-slate-400 text-sm mb-4">${brand.description}</p>

                            ${brand.goal ? `
                            <div class="mb-3 pl-3 border-l-2 border-sa-blue/30">
                                <p class="text-xs text-slate-500 uppercase font-bold mb-1">Strategic Goal</p>
                                <p class="text-slate-300 text-sm italic">"${brand.goal}"</p>
                            </div>
                            ` : ''}

                            ${brand.metrics ? `
                            <div class="mb-4">
                                <p class="text-xs text-slate-500 uppercase font-bold mb-2">Success Metrics</p>
                                <div class="flex flex-wrap gap-2">
                                    ${brand.metrics.map(m => `<span
                                        class="px-2 py-1 bg-slate-900 border border-slate-700 text-xs text-sa-blue rounded font-mono">${m}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}

                            ${brand.series ? `
                            <div class="mb-3">
                                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Series</h4>
                                <ul class="list-disc pl-5 text-slate-300 text-sm space-y-1">
                                    ${brand.series.map(s => `<li>${s}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}

                            ${brand.studios ? `
                            <div class="flex flex-wrap gap-2 mt-2">
                                ${brand.studios.map(studio => `
                                <span
                                    class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded bg-slate-800 text-slate-400 border border-slate-700">${studio.replace('Allmer ', '')}</span>
                        `).join('')}
                            </div>
                            ` : ''}
                        </div>
                        <div class="mt-4 pt-4 border-t border-slate-800">
                            <span class="text-xs font-bold text-sa-blue uppercase tracking-wider">Brand Identity</span>
                        </div>
                    </div>
                    `;

                container.innerHTML = `
                    <div class="max-w-4xl mx-auto mt-8">
                        <h2 class="text-3xl font-bold text-sa-blue mb-10 text-center">Brands</h2>

                        <div class="mb-12">
                            <h3 class="text-xl font-display font-bold text-white mb-6 border-b border-slate-800 pb-2">
                                Multi Studio Brands</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                ${multiStudioBrands.map(renderBrandCard).join('')}
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xl font-display font-bold text-white mb-6 border-b border-slate-800 pb-2">
                                Single Studio Brands</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                ${singleStudioBrands.map(renderBrandCard).join('')}
                            </div>
                        </div>
                    </div>
                    `;
            }

            function renderDictionary(container) {
                // Sort dictionary alphabetically by name
                const sortedData = [...dictionaryData].sort((a, b) => a.name.localeCompare(b.name));

                container.innerHTML = `
                    <div class="max-w-4xl mx-auto mt-8">
                        <h2 class="text-3xl font-bold text-sa-blue mb-8 text-center">IP Dictionary</h2>

                        <div class="mb-8">
                            <input type="text" id="dict-search" onkeyup="filterDictionary()"
                                placeholder="Search for Brands, Studios, or Locations..."
                                class="w-full p-4 rounded-xl bg-slate-900 border border-slate-700 text-white focus:border-sa-blue focus:outline-none transition-colors shadow-lg">
                        </div>

                        <div id="dict-list" class="space-y-4">
                            ${sortedData.map(item => `
                            <div
                                class="dict-item dashboard-card p-6 flex flex-col md:flex-row justify-between items-start md:items-center hover:bg-slate-800/50 transition-all">
                                <div>
                                    <div class="flex items-center gap-3 mb-1">
                                        <h3 class="text-xl font-bold text-white">${item.name}</h3>
                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border ${item.type === 'Studio' ? 'bg-purple-900/30 text-purple-400 border-purple-800' :
                        item.type === 'Brand' ? 'bg-blue-900/30 text-blue-400 border-blue-800' :
                            item.type === 'Location' ? 'bg-green-900/30 text-green-400 border-green-800' :
                                item.type === 'Concept' ? 'bg-teal-900/30 text-teal-400 border-teal-800' :
                                    'bg-slate-800 text-slate-400 border-slate-700'
                    }">${item.type}</span>
                                    </div>
                                    <p class="text-slate-400 text-sm">${item.description}</p>
                                </div>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                    `;
            }

            function renderProcesses(container) {
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto mt-8 text-center">
                        <h2 class="text-3xl font-bold text-sa-blue mb-6">Processes</h2>
                        <div class="dashboard-card p-12">
                            <svg class="w-20 h-20 mx-auto text-slate-600 mb-6" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                                </path>
                            </svg>
                            <h3 class="text-xl font-bold text-white mb-2">Process Documentation</h3>
                            <p class="text-slate-400">Standard operating procedures and workflows are currently being
                                updated.</p>
                            <p class="text-slate-500 text-sm mt-4">Check back soon for the new documentation.</p>
                        </div>
                    </div>
                    `;
            }

            window.filterDictionary = function () {
                const input = document.getElementById('dict-search');
                const filter = input.value.toUpperCase();
                const container = document.getElementById('dict-list');
                const items = container.getElementsByClassName('dict-item');

                for (let i = 0; i < items.length; i++) {
                    const txtValue = items[i].textContent || items[i].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        items[i].style.display = "";
                    } else {
                        items[i].style.display = "none";
                    }
                }
            }

            // --- SUB PAGE LOGIC ---
            window.showSubPage = function (pageId, data = null) {
                const main = document.getElementById('main-content');
                const sub = document.getElementById('sub-page-container');

                main.classList.add('hidden');
                sub.classList.remove('hidden');

                if (pageId === 'communications') {
                    renderCommunicationsPage(sub);
                } else if (pageId === 'region') {
                    renderRegionPage(sub, data);
                }
            }

            window.closeSubPage = function () {
                const main = document.getElementById('main-content');
                const sub = document.getElementById('sub-page-container');

                sub.classList.add('hidden');
                main.classList.remove('hidden');
            }

            function renderCommunicationsPage(container) {
                container.innerHTML = `
                        <div class="mb-8 flex items-center">
                            <button onclick="closeSubPage()"
                                class="mr-4 p-2 rounded-full bg-slate-800 hover:bg-slate-700 text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                            </button>
                            <h2 class="text-3xl font-display font-bold text-white">Communications</h2>
                        </div>

                        <div class="bg-surface border border-slate-800 rounded-xl overflow-hidden shadow-2xl">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr
                                            class="bg-slate-900/50 text-slate-400 text-sm uppercase tracking-wider border-b border-slate-800">
                                            <th class="p-4 font-semibold">Username</th>
                                            <th class="p-4 font-semibold">Full Name</th>
                                            <th class="p-4 font-semibold">Website</th>
                                            <th class="p-4 font-semibold">Platforms</th>
                                            <th class="p-4 font-semibold">Subscribers</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-800">
                                        ${communicationsData.map(item => `
                                        <tr class="hover:bg-slate-800/30 transition-colors">
                                            <td class="p-4">
                                                <a href="${item.url}" target="_blank"
                                                    class="text-sa-blue font-bold hover:text-white hover:underline transition-colors">
                                                    ${item.handle}
                                                </a>
                                            </td>
                                            <td class="p-4 text-slate-300 font-medium">${item.name}</td>
                                            <td class="p-4">
                                                ${item.website ? `<a href="https://${item.website}" target="_blank"
                                                    class="text-slate-400 hover:text-white hover:underline transition-colors">${item.website}</a>`
                        : '<span class="text-slate-600">--</span>'}
                                            </td>
                                            <td class="p-4">
                                                <div class="flex gap-3">
                                                    ${Object.entries(item.platforms).map(([plat, active]) => {
                            if (!active) return '';
                            const username = item.handle.replace('@', '');
                            let url = '#';
                            if (plat === 'YouTube') url =
                                `https://www.youtube.com/${item.handle}`;
                            else if (plat === 'Instagram') url =
                                `https://www.instagram.com/${username}`;
                            else if (plat === 'Threads') url =
                                `https://www.threads.net/@${username}`;
                            else if (plat === 'X') url = `https://x.com/${username}`;

                            return `
                                                    <a href="${url}" target="_blank"
                                                        class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 hover:text-white hover:border-slate-500 transition-all"
                                                        title="${plat}">
                                                        ${plat}
                                                        <svg class="ml-1 w-3 h-3 text-status-green" fill="none"
                                                            viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2" d="M5 13l4 4L19 7" />
                                                        </svg>
                                                    </a>
                                                    `}).join('')}
                                                </div>
                                            </td>
                                            <td class="p-4 text-slate-500 italic">--</td>
                                        </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        `;
            }

            function renderRegionPage(container, regionName) {
                const countries = Object.entries(countryData).filter(([_, data]) => data.region === regionName);

                container.innerHTML = `
                        <div class="mb-8 flex items-center">
                            <button onclick="closeSubPage()"
                                class="mr-4 p-2 rounded-full bg-slate-800 hover:bg-slate-700 text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                            </button>
                            <h2 class="text-3xl font-display font-bold text-white">${regionName} Operations</h2>
                        </div>

                        ${countries.length === 0 ? `<div class="text-center text-slate-500 py-20">No active operations
                            in this region.</div>` : `
                        <div
                            class="bg-surface border border-slate-800 rounded-2xl p-6 md:p-8 shadow-2xl max-w-6xl mx-auto">
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                                ${countries.map(([name, data]) => `
                                <button
                                    class="country-btn flex flex-col items-center justify-center p-4 rounded-xl border-status-${data.presenceLevel} status-${data.presenceLevel} h-32 w-full bg-slate-900/50 hover:bg-slate-800 transition-all"
                                    onclick="showCountryModal('${name}')">
                                    <span class="text-4xl mb-3 filter drop-shadow-lg">${data.flag}</span>
                                    <span class="text-sm text-slate-200 font-bold leading-tight">${name}</span>
                                </button>
                                `).join('')}
                            </div>
                        </div>
                        `}
                        `;
            }

            // --- INTERACTIVITY ---
            window.toggleDivision = function (el) {
                const list = el.querySelector('div.hidden, div.block');
                const text = el.querySelector('p');
                if (list.classList.contains('hidden')) {
                    list.classList.remove('hidden');
                    list.classList.add('block');
                    text.textContent = '(Click to Collapse â–´)';
                } else {
                    list.classList.add('hidden');
                    list.classList.remove('block');
                    text.textContent = '(Click to Expand â–¾)';
                }
            };

            window.showModal = function (title, content = null) {
                // Intercept Communications
                if (title === 'Communications') {
                    showSubPage('communications');
                    return;
                }
                // Intercept Regions
                if (['America', 'Europe', 'Africa', 'Asia'].includes(title)) {
                    showSubPage('region', title);
                    return;
                }

                const modal = document.getElementById('detail-modal');
                const backdrop = document.getElementById('modal-backdrop');
                const panel = document.getElementById('modal-panel');

                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-body').innerHTML = content || `<p class="text-slate-300">Details
                            for ${title} coming soon.</p>`;

                modal.classList.remove('hidden');
                // Trigger animation
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    panel.classList.remove('opacity-0', 'scale-95');
                    panel.classList.add('opacity-100', 'scale-100');
                }, 10);
            };

            window.closeModal = function () {
                const modal = document.getElementById('detail-modal');
                const backdrop = document.getElementById('modal-backdrop');
                const panel = document.getElementById('modal-panel');

                backdrop.classList.add('opacity-0');
                panel.classList.remove('opacity-100', 'scale-100');
                panel.classList.add('opacity-0', 'scale-95');

                setTimeout(() => modal.classList.add('hidden'), 200);
            };
            window.showCountryModal = function (name) {
                const data = countryData[name];
                const color = data.presenceLevel === 'green' ? 'text-status-green' : (data.presenceLevel === 'yellow' ? 'text-status-yellow' : 'text-status-red');

                // Helper to parse population and generate dots
                const generatePopulationDots = (popString) => {
                    const match = popString.match(/([\d.]+)\s*(M|Million|B|Billion)/i);
                    if (!match) return '';
                    let val = parseFloat(match[1]);
                    if (match[2].toUpperCase().startsWith('B')) val *= 1000;
                    const dotCount = Math.floor(val);
                    if (dotCount === 0) return '';
                    return '<div class="flex flex-wrap gap-1 mt-2">' + Array(dotCount).fill('').map(() => '<span class="w-2 h-2 rounded-full bg-sa-blue"></span>').join('') + '</div>';
                };

                const countryPopDots = generatePopulationDots(data.population);

                // Setup highlight logic
                window.highlightEntity = function (type, identifiers, cityName = null, cityPop = null) {
                    // Reset all
                    document.querySelectorAll('.highlight-target').forEach(el => {
                        el.classList.remove('bg-white', 'text-slate-900', 'scale-105', 'shadow-lg', 'ring-2', 'ring-sa-blue');
                        el.classList.remove('opacity-50');
                    });

                    // If clicking the same city, just return (already reset)
                    if (cityName && window.selectedCity === cityName) {
                        window.selectedCity = null;
                        return; // Reset done above
                    }

                    if (cityName) window.selectedCity = cityName;
                    else window.selectedCity = null;

                    if (!identifiers || identifiers.length === 0) return;

                    // Dim others
                    document.querySelectorAll('.highlight-target').forEach(el => el.classList.add('opacity-50'));

                    // Highlight Targets
                    identifiers.forEach(id => {
                        const target = document.getElementById('partner-' + id) || document.getElementById('city-' + id);
                        if (target) {
                            target.classList.remove('opacity-50');
                            target.classList.add('bg-white', 'text-slate-900', 'scale-105', 'shadow-lg', 'ring-2', 'ring-sa-blue');
                        }
                    });
                };

                const html = `
                    <div class="space-y-6" onclick="highlightEntity(null, null)">
                        <!-- General Information -->
                        <div>
                            <h4 class="text-lg font-bold text-white border-b border-slate-700 pb-2 mb-3">General Information</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div id="population-display" class="bg-slate-900 p-3 rounded border border-slate-800">
                                    <p class="text-xs text-slate-500 uppercase font-bold">${name} Population</p>
                                    <p class="text-white font-mono text-lg">${data.population}</p>
                                    ${countryPopDots}
                                </div>
                                <div class="bg-slate-900 p-3 rounded border border-slate-800">
                                    <p class="text-xs text-slate-500 uppercase font-bold mb-1">Cities of Operations</p>
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        ${data.cities && data.cities.length > 0 ? data.cities.map(city => {
                    // Find partners/RE in this city
                    const partnersInCity = (data.partners || []).filter(p => {
                        const cities = typeof p === 'object' ? p.cities : [];
                        return cities && cities.includes(city);
                    }).map(p => typeof p === 'string' ? p : p.name);

                    const reInCity = (data.realEstateDetails || []).filter(r => r.city === city).map(r => r.name);

                    const targets = [...partnersInCity, ...reInCity].map(t => `'${t.replace(/\s+/g, '-')}'`).join(',');

                    return `<button id="city-${city.replace(/\s+/g, '-')}" 
                                                class="highlight-target px-3 py-1 rounded bg-slate-800 text-slate-300 text-sm border border-slate-700 hover:border-sa-blue transition-all duration-300"
                                                onclick="event.stopPropagation(); highlightEntity('city', [${targets}], '${city}')">
                                                ${city}
                                            </button>`;
                }).join('') : '<span class="text-red-500 font-bold italic">Needs Approval</span>'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Operational Status -->
                        <div>
                            <h4 class="text-lg font-bold text-white border-b border-slate-700 pb-2 mb-3">Operational Status</h4>
                            <div class="bg-slate-900 p-4 rounded border border-slate-800">
                                <p class="${color} font-bold text-lg capitalize mb-1">${data.presenceLevel === 'red' ? 'Digital / Partners Only' : (data.presenceLevel === 'yellow' ? 'Active Partners' : 'Physical Presence')}</p>
                                <p class="text-slate-300 text-sm">${data.note}</p>
                            </div>
                        </div>

                        ${name === 'Austria' ? `
                            <!-- Events -->
                            <div>
                                <h4 class="text-lg font-bold text-white border-b border-slate-700 pb-2 mb-3">Events</h4>
                                <div class="space-y-3">
                                    <div class="bg-slate-900 p-4 rounded border border-slate-800 hover:border-sa-blue transition-colors">
                                        <div class="flex justify-between items-start mb-2">
                                            <h5 class="text-white font-bold">Spielefest Wien</h5>
                                            <a href="https://spielefest.wien/" target="_blank" class="text-xs text-sa-blue hover:text-white border border-sa-blue/30 hover:border-white rounded px-2 py-1 transition-all">Visit â†—</a>
                                        </div>
                                        <div class="flex gap-4 text-sm">
                                            <span class="text-slate-400"><span class="text-slate-500 font-bold">Date:</span> Nov 2025</span>
                                            <span class="text-slate-400"><span class="text-slate-500 font-bold">Visitors:</span> ~80,000</span>
                                        </div>
                                    </div>
                                     <div class="bg-slate-900 p-4 rounded border border-slate-800 hover:border-sa-blue transition-colors">
                                        <div class="flex justify-between items-start mb-2">
                                            <h5 class="text-white font-bold">Game City Wien</h5>
                                            <a href="https://game-city.at/" target="_blank" class="text-xs text-sa-blue hover:text-white border border-sa-blue/30 hover:border-white rounded px-2 py-1 transition-all">Visit â†—</a>
                                        </div>
                                        <div class="flex gap-4 text-sm">
                                            <span class="text-slate-400"><span class="text-slate-500 font-bold">Date:</span> Oct 2025</span>
                                            <span class="text-slate-400"><span class="text-slate-500 font-bold">Visitors:</span> ~100,000+</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Key Operations -->
                        <div>
                            <h4 class="text-lg font-bold text-white border-b border-slate-700 pb-2 mb-3">Key Operations</h4>
                            <div class="space-y-3">
                                ${data.partners && data.partners.length ? `
                                    <div class="bg-slate-900 p-3 rounded border border-slate-800">
                                        <p class="text-xs text-slate-500 uppercase font-bold">Strategic Partners</p>
                                        <div class="flex flex-wrap gap-2 mt-2">
                                            ${data.partners.map(p => {
                    const name = typeof p === 'string' ? p : p.name;
                    const url = typeof p === 'object' && p.url ? p.url : null;
                    const cityList = typeof p === 'object' && p.cities ? p.cities.map(c => `'${c.replace(/\s+/g, '-')}'`).join(',') : '';
                    const clickHandler = `event.stopPropagation(); highlightEntity('city', [${cityList}]);`;

                    if (url) {
                        return `<div class="inline-flex items-center gap-2">
                                                        <span id="partner-${name.replace(/\s+/g, '-')}" class="highlight-target cursor-pointer px-3 py-1 rounded bg-slate-800 text-sa-blue border border-slate-700 hover:border-white transition-all duration-300" onclick="${clickHandler}">${name}</span>
                                                        <a href="${url}" target="_blank" class="text-xs text-sa-blue hover:text-white">Visit â†—</a>
                                                    </div>`;
                    } else {
                        return `<span id="partner-${name.replace(/\s+/g, '-')}" class="highlight-target cursor-pointer px-3 py-1 rounded bg-slate-800 text-slate-300 border border-slate-700 hover:border-white transition-all duration-300" onclick="${clickHandler}">${name}</span>`;
                    }
                }).join('')}
                                        </div>
                                    </div>
                                ` : ''}

                                ${data.realEstate > 0 ? `
                                    <div class="bg-slate-900 p-3 rounded border border-slate-800">
                                        <p class="text-xs text-slate-500 uppercase font-bold">Real Estate Holdings (${data.realEstate})</p>
                                        <div class="flex flex-wrap gap-2 mt-2">
                                            ${data.realEstateDetails.map(d => {
                    const cityList = d.city ? `'${d.city.replace(/\s+/g, '-')}'` : '';
                    return `<span id="partner-${d.name.replace(/\s+/g, '-')}" class="highlight-target cursor-pointer px-3 py-1 rounded bg-slate-800 text-slate-300 border border-slate-700 hover:border-white transition-all duration-300" onclick="event.stopPropagation(); highlightEntity('city', [${cityList}])">
                                                    ${d.name} <span class="text-slate-500 ml-1 text-xs">(${d.type})</span>
                                                </span>`;
                }).join('')}
                                        </div>
                                    </div>
                                ` : ''}

                                ${data.contacts ? `
                                    <div class="bg-slate-900 p-3 rounded border border-slate-800">
                                        <p class="text-xs text-slate-500 uppercase font-bold text-sa-blue mb-2">Key Contacts</p>
                                        <div class="space-y-2">
                                            ${data.contacts.map(c => `
                                                <div class="flex justify-between items-center text-sm border-b border-slate-800 pb-1 last:border-0">
                                                    <span class="text-white font-bold">${c.name}</span>
                                                    <span class="text-slate-400 text-xs">${c.city}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                showModal(`${data.flag} ${name}`, html);
            };

            // --- LEDGER ---
            function setupLedger() {
                if (!db || !userId) return;
                const q = query(collection(db, LEDGER_PATH), where("accountId", "==", ACCOUNT_ID));
                onSnapshot(q, (snapshot) => {
                    const txs = [];
                    snapshot.forEach(doc => txs.push(doc.data()));
                    txs.sort((a, b) => (a.timestamp?.toMillis?.() || 0) - (b.timestamp?.toMillis?.() || 0));

                    let bal = 0;
                    const rows = txs.map(tx => {
                        bal += (tx.debit || 0) - (tx.credit || 0);
                        return `< div class="flex justify-between py-1 border-b border-slate-800" >
                            <span>${tx.description}</span><span class="text-sa-blue">${bal.toFixed(2)}â‚¬</span>
                        </div >`;
                    }).join('');
                    document.getElementById('ledger-list').innerHTML = rows || 'No transactions.';
                });
            }

            window.addDeposit = async function () {
                if (!db) return alert("Database not ready");
                await addDoc(collection(db, LEDGER_PATH), {
                    accountId: ACCOUNT_ID, description: 'Quick Deposit', debit: 5, credit: 0, timestamp:
                        serverTimestamp(), userId
                });
            };

            // Init
            initFirebase();
            // Note: switchTab('home') is now called after password authentication


        </script>

        <!-- Footer -->
        <footer class="border-t border-slate-800 mt-20 py-6">
            <div class="max-w-7xl mx-auto px-4 text-center">
                <p class="text-slate-500 text-sm">
                    <span class="text-slate-400 font-semibold">Simon Allmer Portfolio</span> â€” Private
                    Document. Not for
                    sharing.
                </p>
            </div>
        </footer>
    </div>
    <!-- End Main App -->
</body>

</html>